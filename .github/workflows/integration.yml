name: integration

on:
  push:
    branches:
      - master
  pull_request:
    branches:
      - master

permissions:
  contents: read

env:
  CARGO_TERM_COLOR: always

jobs:
  rust-integration:
    name: Rust SDK integration tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        run: rustup toolchain install stable

      - uses: Swatinem/rust-cache@v2

      - name: Build server
        run: cargo build --release -p ruststack-server

      - name: Start server in background
        run: |
          S3_SKIP_SIGNATURE_VALIDATION=true \
          GATEWAY_LISTEN=127.0.0.1:4566 \
          LOG_LEVEL=info \
          cargo run --release -p ruststack-server &

          # Wait for the server to be ready.
          for i in $(seq 1 30); do
            if curl -sf http://127.0.0.1:4566/_localstack/health > /dev/null 2>&1; then
              echo "Server is ready"
              break
            fi
            if [ "$i" -eq 30 ]; then
              echo "::error::Server did not start within 30s"
              exit 1
            fi
            sleep 1
          done

      - name: Run integration tests
        run: cargo test -p ruststack-integration -- --ignored
        env:
          S3_ENDPOINT_URL: http://127.0.0.1:4566

  mint:
    name: MinIO Mint multi-SDK tests
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/master'
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        run: rustup toolchain install stable

      - uses: Swatinem/rust-cache@v2

      - name: Build server
        run: cargo build --release -p ruststack-server

      - name: Start server in background
        run: |
          S3_SKIP_SIGNATURE_VALIDATION=true \
          GATEWAY_LISTEN=0.0.0.0:4566 \
          LOG_LEVEL=warn \
          cargo run --release -p ruststack-server &

          for i in $(seq 1 30); do
            if curl -sf http://127.0.0.1:4566/_localstack/health > /dev/null 2>&1; then
              echo "Server is ready"
              break
            fi
            if [ "$i" -eq 30 ]; then
              echo "::error::Server did not start within 30s"
              exit 1
            fi
            sleep 1
          done

      - name: Run Mint tests
        run: |
          mkdir -p /tmp/mint-logs
          docker run --rm --network host \
            -e SERVER_ENDPOINT=127.0.0.1:4566 \
            -e ACCESS_KEY=test \
            -e SECRET_KEY=test \
            -e ENABLE_HTTPS=0 \
            -v /tmp/mint-logs:/mint/log \
            minio/mint:latest 2>&1 | tee /tmp/mint-logs/mint-output.txt || true

          # Assert we don't regress below the current number of passing suites.
          # Mint prints "Executed N out of 15 tests successfully." at the end.
          # Passing: aws-sdk-java, aws-sdk-java-v2, aws-sdk-ruby, awscli,
          # healthcheck, minio-go, s3cmd, versioning (8/15).
          # Remaining blockers: S3 Select (3), bucket policy enforcement (1),
          # bucket replication (1), listenBucketNotification auth (1),
          # minio-js cleanup (1).
          MIN_PASS=8
          PASS_COUNT=$(grep -oP 'Executed \K[0-9]+' /tmp/mint-logs/mint-output.txt || echo "0")
          FAIL_COUNT=$(grep -c '"status": "FAIL"' /tmp/mint-logs/mint-output.txt || true)
          echo "Mint results: $PASS_COUNT passed, $FAIL_COUNT failed (minimum required: $MIN_PASS)"
          if [ "$PASS_COUNT" -lt "$MIN_PASS" ]; then
            echo "::error::Mint regression: only $PASS_COUNT suites passed (minimum: $MIN_PASS)"
            exit 1
          fi

      - name: Upload Mint logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: mint-logs
          path: /tmp/mint-logs/
          if-no-files-found: ignore

  alternator:
    name: DynamoDB Alternator compatibility tests
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/master'
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        run: rustup toolchain install stable

      - uses: Swatinem/rust-cache@v2

      - name: Build server
        run: cargo build --release -p ruststack-server

      - name: Start server in background
        run: |
          DYNAMODB_SKIP_SIGNATURE_VALIDATION=true \
          S3_SKIP_SIGNATURE_VALIDATION=true \
          GATEWAY_LISTEN=0.0.0.0:4566 \
          LOG_LEVEL=warn \
          cargo run --release -p ruststack-server &

          for i in $(seq 1 30); do
            if curl -sf http://127.0.0.1:4566/_localstack/health > /dev/null 2>&1; then
              echo "Server is ready"
              break
            fi
            if [ "$i" -eq 30 ]; then
              echo "::error::Server did not start within 30s"
              exit 1
            fi
            sleep 1
          done

      - name: Set up Alternator tests
        run: |
          sudo apt-get update
          sudo apt-get install -y python3-pip python3-venv
          bash tests/dynamodb-compat/setup.sh

      - name: Run Alternator tests
        run: |
          cd tests/dynamodb-compat/vendor
          ../../../tests/dynamodb-compat/.venv/bin/pytest -v \
            --url http://localhost:4566 \
            test_table.py test_item.py test_batch.py test_query.py test_scan.py \
            test_condition_expression.py test_filter_expression.py test_update_expression.py \
            test_projection_expression.py test_key_condition_expression.py test_number.py \
            test_nested.py test_describe_table.py test_returnvalues.py test_expected.py \
            -k "not scylla" \
            2>&1 | tee /tmp/alternator-output.txt || true

          # Assert minimum passing threshold.
          # Current: 457 passed (all non-skipped tests).
          MIN_PASS=450
          PASS_COUNT=$(grep -oP '\d+ passed' /tmp/alternator-output.txt | grep -oP '\d+' || echo "0")
          FAIL_COUNT=$(grep -oP '\d+ failed' /tmp/alternator-output.txt | grep -oP '\d+' || echo "0")
          echo "Alternator results: $PASS_COUNT passed, $FAIL_COUNT failed (minimum required: $MIN_PASS)"
          if [ "$PASS_COUNT" -lt "$MIN_PASS" ]; then
            echo "::error::Alternator regression: only $PASS_COUNT tests passed (minimum: $MIN_PASS)"
            exit 1
          fi

      - name: Upload Alternator logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: alternator-logs
          path: /tmp/alternator-output.txt
          if-no-files-found: ignore
