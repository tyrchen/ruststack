name: integration

on:
  push:
    branches:
      - master
  pull_request:
    branches:
      - master

permissions:
  contents: read

env:
  CARGO_TERM_COLOR: always

jobs:
  rust-integration:
    name: Rust SDK integration tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        run: rustup toolchain install stable

      - uses: Swatinem/rust-cache@v2

      - name: Build server
        run: cargo build --release -p ruststack-s3-server

      - name: Start server in background
        run: |
          S3_SKIP_SIGNATURE_VALIDATION=true \
          GATEWAY_LISTEN=127.0.0.1:4566 \
          LOG_LEVEL=info \
          cargo run --release -p ruststack-s3-server &

          # Wait for the server to be ready.
          for i in $(seq 1 30); do
            if curl -sf http://127.0.0.1:4566/_localstack/health > /dev/null 2>&1; then
              echo "Server is ready"
              break
            fi
            if [ "$i" -eq 30 ]; then
              echo "::error::Server did not start within 30s"
              exit 1
            fi
            sleep 1
          done

      - name: Run integration tests
        run: cargo test -p ruststack-s3-integration -- --ignored
        env:
          S3_ENDPOINT_URL: http://127.0.0.1:4566

  mint:
    name: MinIO Mint multi-SDK tests
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/master'
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        run: rustup toolchain install stable

      - uses: Swatinem/rust-cache@v2

      - name: Build server
        run: cargo build --release -p ruststack-s3-server

      - name: Start server in background
        run: |
          S3_SKIP_SIGNATURE_VALIDATION=true \
          GATEWAY_LISTEN=0.0.0.0:4566 \
          LOG_LEVEL=warn \
          cargo run --release -p ruststack-s3-server &

          for i in $(seq 1 30); do
            if curl -sf http://127.0.0.1:4566/_localstack/health > /dev/null 2>&1; then
              echo "Server is ready"
              break
            fi
            if [ "$i" -eq 30 ]; then
              echo "::error::Server did not start within 30s"
              exit 1
            fi
            sleep 1
          done

      - name: Run Mint tests
        run: |
          mkdir -p /tmp/mint-logs
          docker run --rm --network host \
            -e SERVER_ENDPOINT=127.0.0.1:4566 \
            -e ACCESS_KEY=test \
            -e SECRET_KEY=test \
            -e ENABLE_HTTPS=0 \
            -v /tmp/mint-logs:/mint/log \
            minio/mint:latest 2>&1 | tee /tmp/mint-logs/mint-output.txt || true

          # Count FAIL lines from Mint output. Allow up to 3 failures
          # (presigned POST in 2 SDKs + S3 Select are known out-of-scope).
          FAIL_COUNT=$(grep -c '"status": "FAIL"' /tmp/mint-logs/mint-output.txt || true)
          echo "Mint failures: $FAIL_COUNT"
          if [ "$FAIL_COUNT" -gt 3 ]; then
            echo "::error::Too many Mint failures ($FAIL_COUNT > 3 threshold)"
            exit 1
          fi

      - name: Upload Mint logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: mint-logs
          path: /tmp/mint-logs/
          if-no-files-found: ignore
