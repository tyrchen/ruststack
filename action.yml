name: "RustStack"
description: "Start a high-performance AWS-compatible server (S3 + DynamoDB) on localhost:4566 (drop-in replacement for LocalStack)"
author: "Tyr Chen"

branding:
  icon: "database"
  color: "orange"

inputs:
  image-tag:
    description: "Docker image tag to use"
    required: false
    default: "latest"
  port:
    description: "Host port to bind the service to"
    required: false
    default: "4566"
  default-region:
    description: "Default AWS region"
    required: false
    default: "us-east-1"
  log-level:
    description: "Log level (error, warn, info, debug, trace)"
    required: false
    default: "info"
  wait-timeout:
    description: "Seconds to wait for the service to become healthy"
    required: false
    default: "30"
  access-key:
    description: "AWS access key for authentication (set to empty to disable auth)"
    required: false
    default: "test"
  secret-key:
    description: "AWS secret key for authentication (set to empty to disable auth)"
    required: false
    default: "test"
  s3-skip-auth:
    description: "Skip S3 signature validation (true/false)"
    required: false
    default: "true"
  dynamodb-skip-auth:
    description: "Skip DynamoDB signature validation (true/false)"
    required: false
    default: "true"
  persistence:
    description: "Enable durable storage persistence (true/false)"
    required: false
    default: "false"

outputs:
  endpoint:
    description: "The service endpoint URL (used as AWS_ENDPOINT_URL for both S3 and DynamoDB)"
    value: ${{ steps.start.outputs.endpoint }}
  container-id:
    description: "The Docker container ID (for advanced usage)"
    value: ${{ steps.start.outputs.container_id }}

runs:
  using: "composite"
  steps:
    - name: Pull RustStack image
      shell: bash
      run: |
        docker pull "ghcr.io/tyrchen/ruststack:${{ inputs.image-tag }}"

    - name: Start RustStack
      id: start
      shell: bash
      run: |
        CONTAINER_ID=$(docker run -d \
          --name ruststack \
          -p "${{ inputs.port }}:4566" \
          -e "DEFAULT_REGION=${{ inputs.default-region }}" \
          -e "LOG_LEVEL=${{ inputs.log-level }}" \
          -e "S3_SKIP_SIGNATURE_VALIDATION=${{ inputs.s3-skip-auth }}" \
          -e "DYNAMODB_SKIP_SIGNATURE_VALIDATION=${{ inputs.dynamodb-skip-auth }}" \
          -e "ACCESS_KEY=${{ inputs.access-key }}" \
          -e "SECRET_KEY=${{ inputs.secret-key }}" \
          -e "PERSISTENCE=${{ inputs.persistence }}" \
          "ghcr.io/tyrchen/ruststack:${{ inputs.image-tag }}")

        echo "container_id=$CONTAINER_ID" >> "$GITHUB_OUTPUT"
        echo "endpoint=http://localhost:${{ inputs.port }}" >> "$GITHUB_OUTPUT"

    - name: Wait for healthy
      shell: bash
      run: |
        ENDPOINT="http://localhost:${{ inputs.port }}"
        TIMEOUT=${{ inputs.wait-timeout }}
        ELAPSED=0

        echo "Waiting for RustStack at $ENDPOINT ..."

        until curl -sf "$ENDPOINT/_localstack/health" > /dev/null 2>&1; do
          if [ "$ELAPSED" -ge "$TIMEOUT" ]; then
            echo "::error::RustStack did not become healthy within ${TIMEOUT}s"
            docker logs ruststack
            exit 1
          fi
          sleep 0.5
          ELAPSED=$((ELAPSED + 1))
        done

        echo "RustStack is ready at $ENDPOINT (S3 + DynamoDB)"

    - name: Export environment
      shell: bash
      run: |
        echo "AWS_ENDPOINT_URL=http://localhost:${{ inputs.port }}" >> "$GITHUB_ENV"
        echo "LOCALSTACK_ENDPOINT=http://localhost:${{ inputs.port }}" >> "$GITHUB_ENV"
        echo "AWS_DEFAULT_REGION=${{ inputs.default-region }}" >> "$GITHUB_ENV"
        echo "AWS_ACCESS_KEY_ID=${{ inputs.access-key }}" >> "$GITHUB_ENV"
        echo "AWS_SECRET_ACCESS_KEY=${{ inputs.secret-key }}" >> "$GITHUB_ENV"
